{% load static %}
{% block content %}
<!-- Vendor CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="{% static 'assets/vendor/aos/aos.css' %}" rel="stylesheet" />
<link href="{% static 'assets/vendor/glightbox/css/glightbox.min.css' %}" rel="stylesheet" />
<link href="{% static 'assets/vendor/swiper/swiper-bundle.min.css' %}" rel="stylesheet" />
<link href="{% static 'assets/css/main.css' %}" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #d0bdf4;
    margin: 0;
    padding: 20px;
  }

  main {
    max-width: 1200px;
    margin: 0 auto;
  }

  .appointments-title {
    text-align: center;
    margin-bottom: 20px;
    color: #333;
    font-weight: 600;
  }

  /* --- View Toggle Buttons --- */
  .view-toggle-container {
    text-align: right;
    margin-bottom: 20px;
  }

  .view-toggle-btn {
    background-color: #fff;
    border: 1px solid #ddd;
    padding: 8px 15px;
    cursor: pointer;
    border-radius: 5px;
    font-size: 14px;
    margin-left: 5px;
    transition: background-color 0.3s, color 0.3s;
  }

  .view-toggle-btn:hover {
    background-color: #f0f0f0;
  }

  .view-toggle-btn.active {
    background-color: #c2185b;
    color: #fff;
    border-color: #c2185b;
  }

  .view-toggle-btn .fa-solid {
    margin-right: 5px;
  }

  /* --- Card View Styles --- */
  .view-cards .appointments-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 30px;
    padding: 30px;
  }

  .appointment-item {
    background-color: #ffa8B6;
    border: 1px solid #ddd;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    display: flex;
    flex-direction: column;
    padding: 20px;
  }

  .appointment-item:hover {
    transform: translateY(-8px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
  }

  .view-cards .card-name {
    font-size: 1.3em;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 15px;
  }

  .view-cards .contact-info-flex {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
    padding-bottom: 15px;
  }

  .view-cards .date-display {
    background-color: #f8f9fa;
    color: #3498db;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 8px 12px;
    text-align: center;
    margin-right: 15px;
    min-width: 60px;
  }

  .view-cards .date-day {
    display: block;
    font-size: 1.6em;
    font-weight: bold;
    line-height: 1;
  }

  .view-cards .date-month,
  .view-cards .date-year {
    display: block;
    font-size: 0.8em;
    text-transform: uppercase;
    color: #7f8c8d;
  }

  .view-cards .details {
    font-size: 0.9em;
    color: #555;
    line-height: 1.5;
  }

  .view-cards .description-text {
    font-size: 1em;
    color: #34495e;
    line-height: 1.6;
    margin-top: 15px;
    margin-bottom: 20px;
    flex-grow: 1;
    background-color: #fdfefe;
    border-left: 4px solid #3498db;
    padding: 12px 15px;
    border-radius: 4px;
  }

  .view-cards .action-buttons-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }

  .btn-action {
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
    font-weight: bold;
    transition: opacity 0.2s ease;
    text-align: center;
    color: white;
  }

  .btn-action:hover {
    opacity: 0.85;
  }

  .btn-accept {
    background-color: #2ecc71;
  }

  .btn-reject {
    background-color: #e74c3c;
  }

  .btn-reschedule {
    background-color: #3498db;
  }

  /* --- List View Styles --- */
  .view-list .appointments-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 10px;
  }

  .view-list .appointment-item {
    display: flex;
    flex-direction: row;
    align-items: center;
    flex-wrap: wrap;
    background-color: #ffa8B6;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
  }

  .view-list .appointment-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
    background-color: #fdfdfd;
  }

  .view-list .card-name {
    font-weight: 700;
    font-size: 1.1em;
    color: #2c3e50;
    flex-basis: 180px;
    flex-grow: 1;
  }

  .view-list .details {
    display: flex;
    flex-wrap: wrap;
    flex-basis: 350px;
    flex-grow: 2;
    gap: 8px 20px;
    font-size: 0.92em;
    color: #555;
  }

  .view-list .details span {
    background: #f1f3f5;
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 0.85em;
    color: #444;
  }

  .view-list .action-buttons-container {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    flex-basis: 280px;
    flex-grow: 1;
    margin-left: auto;
  }
</style>
<main>
  <h1 class="appointments-title">Manage Appointments</h1>
  <a href="{% url 'admin:index' %}" class="btn btn-dark">üè† Admin Home</a>
  <a href="{% url 'export_appointments_pdf' %}" class="btn btn-danger">üìÑ Export PDF</a>
  <a href="{% url 'export_appointments_excel' %}" class="btn btn-success">üìä Export Excel</a>
  <a href="{% url 'admin:doctor_appointment_add' %}" class="btn btn-primary">‚ûï Add Appointment</a>
  <div class="view-toggle-container">
    <button id="view-cards-btn" class="view-toggle-btn active" title="Card View">
      <i class="fa-solid fa-grip"></i> Card
    </button>
    <button id="view-list-btn" class="view-toggle-btn" title="List View">
      <i class="fa-solid fa-list"></i> List
    </button>
    <button id="acceptedAppointments" class="view-toggle-btn" title="Accepted Appointments">
      <i class="fa-solid fa-check"></i> Accepted
    </button>
    <button id="rejectedAppointments" class="view-toggle-btn" title="Rejected Appointments">
      <i class="fa-solid fa-times"></i> Rejected
    </button>
    <button id="rescheduledAppointments" class="view-toggle-btn" title="Rescheduled Appointments">
      <i class="fa-solid fa-calendar-alt"></i> Rescheduled
    </button>
  </div>
  <div id="appointmentsContainer" class="view-cards">
    <div class="appointments-container"  id="pending-container">
      {% for appointment in pending_appointments %}
      <div class="appointment-item">
        <h3 class="card-name">{{ appointment.name }}</h3>
        <div class="contact-info-flex">
          <div class="date-display">
            <span class="date-day">{{ appointment.date|date:"d" }}</span>
            <span class="date-month">{{ appointment.date|date:"M"|upper }}</span>
            <span class="date-year">{{ appointment.date|date:"Y"|upper }}</span>
          </div>
          <div class="details">
            <p>{{ appointment.email }}</p>
            <p>{{ appointment.phone }}</p>
            <p>Created: {{ appointment.created_at|date:"d M Y H:i" }}</p>
          </div>
        </div>
        <p class="description-text">{{ appointment.message }}</p>
        <div class="action-buttons-container">
          <button type="button" class="btn-action btn-accept" data-bs-toggle="modal" data-bs-target="#actionModal"
            data-name="{{ appointment.name }}" data-date="{{ appointment.date }}" data-action="Accepted"
            data-id="{{ appointment.id }}">Accept</button>
          <button type="button" class="btn-action btn-reject" data-bs-toggle="modal" data-bs-target="#actionModal"
            data-name="{{ appointment.name }}" data-date="{{ appointment.date }}" data-action="Rejected"
            data-id="{{ appointment.id }}">Reject</button>
          <button type="button" class="btn-action btn-reschedule" data-bs-toggle="modal" data-bs-target="#actionModal"
            data-name="{{ appointment.name }}" data-date="{{ appointment.date }}" data-action="Rescheduled"
            data-id="{{ appointment.id }}">Reschedule</button>
        </div>
      </div>
      {% empty %}
      <div style="text-align:center; grid-column:1/-1">
        <p>No appointments found.</p>
      </div>
      {% endfor %}
    </div>
    <h2 class="appointments-title">Processed Appointments</h2>
    <h4>‚úÖ Accepted</h4>
    <div class="appointments-container" id="accepted-container">
      {% for appointment in accepted_appointments %}
      <div class="appointment-item">
        <h3 class="card-name">{{ appointment.name }}</h3>
        <div class="contact-info-flex">
          <div class="date-display">
            <span class="date-day">{{ appointment.date|date:"d" }}</span>
            <span class="date-month">{{ appointment.date|date:"M"|upper }}</span>
            <span class="date-year">{{ appointment.date|date:"Y"|upper }}</span>
          </div>
          <div class="details">
            <p>{{ appointment.email }}</p>
            <p>{{ appointment.phone }}</p>
            <p>Created: {{ appointment.created_at|date:"d M Y H:i" }}</p>
          </div>
        </div>
        <p class="description-text">{{ appointment.message }}</p>
        
      </div>
      {% empty %}
      <p>No accepted appointments yet.</p>
      {% endfor %}
    </div>
    <h4>‚ùå Rejected</h4>
    <div class="appointments-container" id="rejected-container">
      {% for appointment in rejected_appointments %}
      <div class="appointment-item">
        <h3 class="card-name">{{ appointment.name }}</h3>
        <div class="contact-info-flex">
          <div class="date-display">
            <span class="date-day">{{ appointment.date|date:"d" }}</span>
            <span class="date-month">{{ appointment.date|date:"M"|upper }}</span>
            <span class="date-year">{{ appointment.date|date:"Y"|upper }}</span>
          </div>
          <div class="details">
            <p>{{ appointment.email }}</p>
            <p>{{ appointment.phone }}</p>
            <p>Created: {{ appointment.created_at|date:"d M Y H:i" }}</p>
          </div>
        </div>
        <p class="description-text">{{ appointment.message }}</p>
        
      </div>
      {% empty %}
      <p>No rejected appointments yet.</p>
      {% endfor %}
    </div>
    <h4>üìÖ Rescheduled</h4>
    <div class="appointments-container" id="rescheduled-container">
      {% for appointment in rescheduled_appointments %}
      <div class="appointment-item">
        <h3 class="card-name">{{ appointment.name }}</h3>
        <div class="contact-info-flex">
          <div class="date-display">
            <span class="date-day">{{ appointment.date|date:"d" }}</span>
            <span class="date-month">{{ appointment.date|date:"M"|upper }}</span>
            <span class="date-year">{{ appointment.date|date:"Y"|upper }}</span>
          </div>
          <div class="details">
            <p>{{ appointment.email }}</p>
            <p>{{ appointment.phone }}</p>
            <p>Created: {{ appointment.created_at|date:"d M Y H:i" }}</p>
          </div>
        </div>
        <p class="description-text">{{ appointment.message }}</p>
        
      </div>
      {% empty %}
      <p>No rescheduled appointments yet.</p>
      {% endfor %}
    </div>
    {% if is_paginated %}
    <nav aria-label="Page navigation" class="d-flex justify-content-center mt-4">
      <ul class="pagination">
        {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">¬´ Previous</a></li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">¬´ Previous</span></li>
        {% endif %}
        <li class="page-item disabled">
          <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        </li>
        {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next ¬ª</a></li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Next ¬ª</span></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
</main>
<!-- Modal (only once, outside loop) -->
<div class="modal fade" id="actionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'manage_appointment' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Send Message</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="action_type" id="modalAction" />
          <input type="hidden" name="appointment_id" id="modalAppointmentId" />
          <label for="modalMessage" class="form-label">Message</label>
          <textarea name="message" id="modalMessage" class="form-control" rows="4"></textarea>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" id="modalSubmitButton">Send</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- Get References to Elements ---
    const actionModal = document.getElementById("actionModal");
    const container = document.getElementById("appointmentsContainer");

    // Get references to the new containers
    const pendingContainer = document.getElementById("pending-container");
    const acceptedContainer = document.getElementById("accepted-container");
    const rejectedContainer = document.getElementById("rejected-container");
    const rescheduledContainer = document.getElementById("rescheduled-container");

    let currentCard = null; // A variable to store the card being acted upon

    // --- Modal Logic ---
    if (actionModal) {
      const modalSubmitButton = actionModal.querySelector('button[type="submit"]');

      actionModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        if (!button) return;

        // Store the card that was clicked on
        currentCard = button.closest(".appointment-item");

        // Get data from the button
        const name = button.getAttribute("data-name");
        const date = button.getAttribute("data-date");
        const action = button.getAttribute("data-action");
        const appointmentId = button.getAttribute("data-id");

        // Update hidden inputs in the modal form
        document.getElementById("modalAction").value = action;
        document.getElementById("modalAppointmentId").value = appointmentId;

        // Customize modal text and button style based on the action
        let messageText = `Hi ${name}, your appointment on ${date} has been ${action.toLowerCase()}.`;
        let submitButtonText = "Send";
        let submitButtonClass = "btn btn-primary";

        if (action === "Accepted") {
          submitButtonText = "Confirm Acceptance";
          submitButtonClass = "btn btn-success";
        } else if (action === "Rejected") {
          submitButtonText = "Confirm Rejection";
          submitButtonClass = "btn btn-danger";
        } else if (action === "Rescheduled") {
          submitButtonText = "Confirm Reschedule";
          submitButtonClass = "btn btn-warning";
        }

        document.getElementById("modalMessage").value = messageText;
        modalSubmitButton.textContent = submitButtonText;
        modalSubmitButton.className = submitButtonClass;
      });

      // --- Form Submission Logic ---
      actionModal.querySelector("form").addEventListener("submit", function (e) {
        e.preventDefault(); // Stop the default form submission to update the UI instantly

        const action = document.getElementById("modalAction").value;

        if (currentCard) {
          // *** THE FIX: Move the card to the correct container ***
          if (action === "Accepted" && acceptedContainer) {
            acceptedContainer.appendChild(currentCard);
            updateEmptyMessage(acceptedContainer, "accepted-empty-message");
          } else if (action === "Rejected" && rejectedContainer) {
            rejectedContainer.appendChild(currentCard);
            updateEmptyMessage(rejectedContainer, "rejected-empty-message");
          } else if (action === "Rescheduled" && rescheduledContainer) {
            rescheduledContainer.appendChild(currentCard);
            updateEmptyMessage(rescheduledContainer, "rescheduled-empty-message");
          }
          // Check if the pending list is now empty
          updateEmptyMessage(pendingContainer, "pending-empty-message");
        }

        // Close the modal
        const modalInstance = bootstrap.Modal.getInstance(actionModal);
        modalInstance.hide();

        // Now, submit the form in the background to update the server
        this.submit();
      });
    }

    // --- View Toggle Logic (Card/List) ---
    const cardViewBtn = document.getElementById("view-cards-btn");
    const listViewBtn = document.getElementById("view-list-btn");

    if (cardViewBtn && listViewBtn && container) {
      cardViewBtn.addEventListener("click", function () {
        container.className = "view-cards";
        cardViewBtn.classList.add("active");
        listViewBtn.classList.remove("active");
      });
      listViewBtn.addEventListener("click", function () {
        container.className = "view-list";
        listViewBtn.classList.add("active");
        cardViewBtn.classList.remove("active");
      });
    }

    // --- Helper function to show/hide "empty" messages ---
    function updateEmptyMessage(container, messageId) {
      if (!container) return;
      const messageEl = document.getElementById(messageId);
      if (messageEl) {
        // Check if there are any appointment cards left in the container
        const hasItems = container.querySelector(".appointment-item");
        messageEl.style.display = hasItems ? "none" : "block";
      }
    }
  });
</script>
{% endblock content %}